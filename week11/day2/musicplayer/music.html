<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Foxplayer</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style/style.css">
    <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">
</head>
<body>
    <div class="positioner"></div>
    <div class="container">
        <div class="maincontainer">
            <div class="leftside">
                <div class="topleftbox">
                    <div class="logobox">
                        <div class="logoleft">
                            <div class="logo"></div>
                            <div class="playlistheader">Playlists</div>
                        </div>
                        <div class="logoright">
                            <div class="notifications"></div>
                            <div class="adder"></div>
                        </div>
                    </div>
                    <div class="imageholder"></div>
                </div>
                <div class="playlistbox">
                    <div class="onelist type2 standard1">All tracks</div>
                    <div class="onelist type1 standard2">Favourites</div>
                </div>
            </div>
            <div class="rightside">
                <div class="infobar">
                    <div class="leftinfo">
                        <div class="titleholder">--</div>
                        <div class="artistholder">--</div>
                    </div>
                    <div class="rightinfo">
                        <div class="plus"></div>
                        <div class="star"></div>
                    </div>
                </div>
                <div class="songbox">
                </div>
            </div>
        </div>
        <div class="controlbar">
            <div class="rewind"></div>
            <div class="play"></div>
            <div class="forward"></div>
            <div class="remaintime">-:--</div>
            <input type=range class="seekbar" value="0">
            <div class="totallength">-:--</div>
            <div class="shuffle"></div>
            <div class="volumeimg"></div>
            <input type=range class="volumebar"value="100">
        </div>
    </div>
    <audio></audio>
</body>
</html>

<script>
    'use strict';

// Server control: getting playlists

    var http = new XMLHttpRequest();

    http.onreadystatechange = function() {
        if (http.readyState === 4 && http.status === 200) {
            var playlists = JSON.parse(http.response);
            playlistGenerator(playlists);
        }
    }
    http.open('GET', 'http://localhost:3000/playlists');
    http.send();

    var playlistGenerator = function(playlists) {
        var playlists = playlists;
        var playlistbox = document.querySelector('.playlistbox');
        console.log(playlists);

        for (let i = 1; i < playlists.length; i++) {

            var onelistcont = document.createElement('div');
            playlistbox.appendChild(onelistcont);
            onelistcont.setAttribute('class', 'onelist type' + ((i % 2) + 1));
            onelistcont.addEventListener('click', listClicked);

            var listbox = document.createElement('div');
            onelistcont.appendChild(listbox);
            listbox.innerHTML = playlists[i].title;
            listbox.setAttribute('class', 'listbox');

            var listex = document.createElement('div');
            onelistcont.appendChild(listex);
            listex.innerHTML = '&#10006';
            listex.setAttribute('class', 'listex');
        }

    }


// Server control: getting tracks

    var getTrack = new XMLHttpRequest();

    getTrack.onreadystatechange = function() {
        if (getTrack.readyState === 4 && getTrack.status === 200) {
            var tracks = JSON.parse(getTrack.response);
            songListGenerator(tracks);
            var AudioController = new AudioControl(tracks);
            // audioControl(tracks);
            console.log(tracks);
        }
    }
    getTrack.open('GET', 'http://localhost:3000/tracks');
    getTrack.send();

    var songListGenerator = function(tracks) {
        var tracks = tracks;
        var songbox = document.querySelector('.songbox');

        for (let i = 0; i < tracks.length; i++) {

            let time = timeManagement(tracks[i].duration, i);

            var onesongcont = document.createElement('div');
            songbox.appendChild(onesongcont);
            onesongcont.setAttribute('class', 'onesong' + ((i % 2) + 1));
            onesongcont.addEventListener('click', songClicked);

            var ordernumber = document.createElement('div');
            onesongcont.appendChild(ordernumber);
            ordernumber.innerHTML = i + 1;
            ordernumber.setAttribute('class', 'ordernumber');

            var title = document.createElement('div');
            onesongcont.appendChild(title);
            title.innerHTML = tracks[i].title;
            title.setAttribute('class', 'title');

            var length = document.createElement('div');
            onesongcont.appendChild(length);
            length.innerHTML = time;
            length.setAttribute('class', 'length');
        }
    }

    var timeManagement = function(duration, i) {
        if (duration > 60) {
            var minuteMan = Math.floor(duration / 60) + ':' + Math.floor(duration % 60);
            if (Math.floor(duration % 60)  < 10) {
                minuteMan = Math.floor(duration / 60) + ':0' + Math.floor(duration % 60);
            }
        } else {
            var minuteMan = Math.floor(duration);
        }
        return minuteMan
    }

    function songClicked (e) {
        let color = e.target.parentNode;
        color.setAttribute('style', 'background: rgb(170, 230, 230);');
    }

    function listClicked (e) {
        let color = e.target.parentNode;
        color.setAttribute('style', 'background: rgb(170, 230, 230);');
    }

    var standard1 = document.querySelector('.standard1');
    var standard2 = document.querySelector('.standard2');
    standard1.addEventListener('click', standard1Clicked);
    standard2.addEventListener('click', standard2Clicked);

    function standard1Clicked (e) {
        console.log(e);
        let color = e.target.parentNode.querySelector('.standard1');
        color.setAttribute('style', 'background: rgb(170, 230, 230);');
    }

    function standard2Clicked (e) {
        console.log(e);
        let color = e.target.parentNode.querySelector('.standard2');
        color.setAttribute('style', 'background: rgb(170, 230, 230);');
    }

    var AudioControl = function(tracks) {
        var i = 0;
        var isPlay = 0;
        var counter = 0;
        var tracklist = tracks;
        var audio = document.querySelector('audio');
        var playButton = document.querySelector('.play');
        var rewind = document.querySelector('.rewind');
        var forward = document.querySelector('.forward');
        var remaintime = document.querySelector('.remaintime');
        var seekbarInput = document.querySelector('input:nth-child(5)');
        var totallength = document.querySelector('.totallength');
        var shuffle = document.querySelector('.shuffle');
        var volume = document.querySelector('.volumeimg');
        var volumebarInput = document.querySelector('input:nth-child(9)');
        var titleholder = document.querySelector('.titleholder');
        var artistholder = document.querySelector('.artistholder');
        var path = tracklist[i].path;
        var interval;
        var shuffleOn = false;
        var currentPlay = tracklist[i];
        audio.setAttribute('src', path);
        titleholder.innerHTML = tracklist[0].title;
        artistholder.innerHTML = tracklist[0].artist;

// function songClicked (e) {
//     let onclick = e.target.parentNode.querySelector('.onesongcont');
//     onclick.setAttribute('style', 'background: rgb(170, 230, 230);');
// }






        var playNextTrack = function() {
            if (audio.ended === true && shuffleOn === false) {
                i < tracklist.length - 1 ? i++ : i = 0;
                audio.setAttribute('src', tracklist[i].path);
                totallengthFun();
                titleholder.innerHTML = tracklist[i].title;
                artistholder.innerHTML = tracklist[i].artist;
                audio.play()
            }
            if (audio.ended === true && shuffleOn === true) {
                i = Math.floor(Math.random() * tracklist.length);
                audio.setAttribute('src', tracklist[i].path);
                totallengthFun();
                titleholder.innerHTML = tracklist[i].title;
                artistholder.innerHTML = tracklist[i].artist;
                audio.play()
            }
        };

        var playButtonClicked = function() {
            counter++;

            if (counter % 2 === 1) {
                playButton.setAttribute('style', 'background-image: url(style/images/pause.svg);');
                interval = setInterval(remaintimeCalculator, 1000);
                audio.play();
            } else {
                playButton.setAttribute('style', 'background-image: url(style/images/play.svg);');
                clearInterval(interval);
                audio.pause();
            }
            if (counter === 1) {
                remaintime.innerHTML = timeManagement(tracklist[i].duration);
            }
            totallengthFun();
        };

        var rewindClicked = function() {
            audio.playbackRate--;
        };

        var forwardClicked = function() {
            audio.playbackRate++;
        };

        var remaintimeCalculator = function() {
            seekbarInput.value = (audio.currentTime / tracklist[i].duration) * 100;
            seekbar();
            remaintimeFun();
            playNextTrack();
        };

        var remaintimeFun = function() {
            remaintime.innerHTML = timeManagement(tracklist[i].duration - Math.floor(audio.currentTime));
        };

        var seekbar = function () {
            if (seekbarInput.value >= 50) {
                seekbarInput.setAttribute('style', 'background: linear-gradient(to right, rgb(60, 210, 205) ' + seekbarInput.value + '%, rgb(220, 220, 220)' + (100-seekbarInput.value) + '%);');
            } else {
                seekbarInput.setAttribute('style', 'background: linear-gradient(to left, rgb(220, 220, 220) ' + (100-seekbarInput.value) + '%, rgb(60, 210, 205)' + seekbarInput.value + '%);');
            }
        };

        var timeManagement = function(fulltime) {
            if (fulltime > 60) {
                var minuteMan = Math.floor(fulltime / 60) + ':' + Math.floor(fulltime % 60);
                if (Math.floor(fulltime % 60)  < 10) {
                    minuteMan = Math.floor(fulltime / 60) + ':0' + Math.floor(fulltime % 60);
                }
            } else {
                var minuteMan = Math.floor(fulltime);
            }
            return minuteMan
        };

        var totallengthFun = function() {
            totallength.innerHTML = timeManagement(tracklist[i].duration);
        };

        var shuffleClicked = function() {
            if (shuffleOn === false) {
                shuffleOn = true;
            } else {
                shuffleOn = false;
            }
        };

        var volumeClicked = function() {
            if (audio.muted === false) {
                audio.muted = true;
            } else {
                audio.muted = false;
            }
        };

        var volumebar = function () {
            audio.volume = volumebarInput.value / 100;

            if (volumebarInput.value >= 50) {
                volumebarInput.setAttribute('style', 'background: linear-gradient(to right, rgb(60, 210, 205) ' + volumebarInput.value + '%, rgb(220, 220, 220)' + (100-volumebarInput.value) + '%);');
            } else {
                volumebarInput.setAttribute('style', 'background: linear-gradient(to left, rgb(220, 220, 220) ' + (100-volumebarInput.value) + '%, rgb(60, 210, 205)' + volumebarInput.value + '%);');
            }
        };

        var seek = function () {
            audio.currentTime = seekbarInput.value / 100 * tracklist[i].duration;
        };

        playButton.addEventListener('click', playButtonClicked);
        rewind.addEventListener('click', rewindClicked);
        forward.addEventListener('click', forwardClicked);
        seekbarInput.onchange = seek;
        shuffle.addEventListener('click', shuffleClicked);
        volume.addEventListener('click', volumeClicked);
        volumebarInput.oninput = volumebar;
    };

</script>
